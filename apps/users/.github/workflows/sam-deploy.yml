name: Deploy with AWS SAM

on:
  push:
    branches: [main, dev]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev

env:
  AWS_REGION: eu-north-1

jobs:
  deploy:
    name: Deploy to AWS using SAM
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH Key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ“¦ Initialize Submodules with SSH
        run: |
          # Configure git to use SSH for GitHub
          git config --global url."git@github.com:".insteadOf "https://github.com/"

          # Add GitHub to known hosts to avoid SSH prompts
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          # Force clean any existing submodule state
          git submodule deinit --force --all || true
          rm -rf .git/modules/assets || true
          rm -rf assets || true

          # Initialize and update submodules with retry logic
          for i in {1..3}; do
            echo "Attempt $i to initialize submodules..."
            if git submodule sync --recursive && git submodule update --init --recursive --force; then
              echo "Submodules initialized successfully"
              break
            else
              echo "Failed attempt $i, retrying..."
              sleep 5
            fi
          done

          # Verify submodule was initialized
          if [ ! -d "assets" ]; then
            echo "ERROR: Assets submodule failed to initialize"
            exit 1
          fi

          echo "Submodule status:"
          git submodule status

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: ''

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: ğŸ“¦ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ğŸ—‚ï¸ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ“¥ Install Dependencies
        run: |
          # Run the setup script which handles submodules, assets, and main dependencies
          pnpm run setup

      - name: ğŸ› ï¸ Build Application
        run: pnpm run build

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ—ï¸ Setup SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: ğŸš€ Deploy Infrastructure with SAM
        run: |
          cd infrastructure

          # Determine environment based on branch or manual input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref_name }}" = "main" ]; then
            ENVIRONMENT="prod"
          elif [ "${{ github.ref_name }}" = "dev" ]; then
            ENVIRONMENT="dev"
          else
            ENVIRONMENT="dev"
          fi

          echo "Deploying to environment: $ENVIRONMENT"

          # Deploy with SAM using the appropriate config
          if [ "$ENVIRONMENT" = "prod" ]; then
            sam deploy --config-env default
          else
            sam deploy --config-env dev
          fi

      - name: ğŸ“¤ Get Stack Outputs
        id: stack-outputs
        run: |
          cd infrastructure

          # Determine environment
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref_name }}" = "main" ]; then
            ENVIRONMENT="prod"
          elif [ "${{ github.ref_name }}" = "dev" ]; then
            ENVIRONMENT="dev"
          else
            ENVIRONMENT="dev"
          fi

          # Get outputs from CloudFormation stack
          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name "kpay-user-webapp-${ENVIRONMENT}" \
            --query 'Stacks[0].Outputs[?OutputKey==`WebAppS3BucketName`].OutputValue' \
            --output text)

          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name "kpay-user-webapp-${ENVIRONMENT}" \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
            --output text)

          DOMAIN_NAME=$(aws cloudformation describe-stacks \
            --stack-name "kpay-user-webapp-${ENVIRONMENT}" \
            --query 'Stacks[0].Outputs[?OutputKey==`WebAppDomain`].OutputValue' \
            --output text)

          echo "bucket-name=${BUCKET_NAME}" >> $GITHUB_OUTPUT
          echo "distribution-id=${DISTRIBUTION_ID}" >> $GITHUB_OUTPUT
          echo "domain-name=${DOMAIN_NAME}" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ S3 Bucket: ${BUCKET_NAME}"
          echo "ğŸŒ CloudFront Distribution: ${DISTRIBUTION_ID}"
          echo "ğŸ”— Domain: ${DOMAIN_NAME}"

      - name: â¬†ï¸ Upload Files to S3
        run: |
          echo "Uploading dist/ to s3://${{ steps.stack-outputs.outputs.bucket-name }}"
          aws s3 sync dist/ s3://${{ steps.stack-outputs.outputs.bucket-name }} --delete

      - name: ğŸ§¹ Invalidate CloudFront Cache
        run: |
          echo "Invalidating CloudFront cache for distribution: ${{ steps.stack-outputs.outputs.distribution-id }}"
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.stack-outputs.outputs.distribution-id }} \
            --paths "/*"

      - name: âœ… Deployment Complete
        run: |
          echo "âœ… Deployment complete!"
          echo "ğŸ”— Application URL: https://${{ steps.stack-outputs.outputs.domain-name }}"
